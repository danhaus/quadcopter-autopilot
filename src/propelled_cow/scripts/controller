#!/usr/bin/env python

import rospy
from std_msgs.msg import Int32

import propelled_cow.pid_control as _PID


PID_velocity = rospy.get_param('velocity')
velocity_demand = velocity['demand']
controller = _PID.PID(velocity_PID['Kp'], velocity_PID['Ki'], velocity_PID['Kd'])

pub = rospy.Publisher('PWM_velocity', Int16, queue_size=10)
rospy.init_node('controller', anonymous=True)


def listener():
    rospy.Subscriber('ultrasonic_velocity', Int32, PWM_velocity)

    # spin() simply keeps python from exiting until this node is stopped
    rospy.spin()

def PWM_velocity(data):
    velocity_curr = data.data
    err = velocity_demand - velocity_curr
    PWM_raw = controller.update_PID(err)
    pub.publish(PWM_raw)

if __name__ == '__main__':
    listener()
